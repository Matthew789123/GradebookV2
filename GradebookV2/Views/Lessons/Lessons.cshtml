@model List<Tuple<GradebookV2.Models.Lesson, List<GradebookV2.Models.File>>>
@{
    ViewBag.Title = "Lessons";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@if (User.IsInRole("Teacher"))
{
    @Html.ActionLink("Add lesson", "createLesson", new { classId = ViewBag.classId, subjectId = ViewBag.subjectId }, new { @style = "float:right;margin-top:1%;" })
    @Html.ActionLink("Add test", "createTest", "Tests", new { classId = ViewBag.classId, subjectId = ViewBag.subjectId }, new { @style = "float:right;margin-top:1%;margin-right:1%" })
}
<h2>Lessons - @ViewBag.subject</h2>
<hr />

<h3 style="text-align:center">Tests</h3>
<p class="alert-danger">@ViewBag.testError</p>
<ul>
    @foreach (GradebookV2.Models.Test test in ViewBag.testsList)
    {
    <li>
        <div class="test" value="@test.Start,@test.TestId" style="cursor:pointer">@test.Title</div>
        <p>(@test.Start.ToString().Remove(test.Start.ToString().Length - 3))</p>
        <div class="testError text-danger" value="@test.TestId"></div>
    </li>
    }
</ul>
<hr />

@foreach (Tuple<GradebookV2.Models.Lesson, List<GradebookV2.Models.File>> t in Model)
{
    <h3 style="text-align:center">@t.Item1.Title</h3>
    <p>@t.Item1.Content</p>
    <ul>
        @foreach (GradebookV2.Models.File f in t.Item2)
        {
            <li>@Html.ActionLink(f.FileName, "downloadFile", new { fileId = f.FileId })</li>
        }
    </ul>
    <hr />
}

@section scripts {
    <script type="text/javascript">

        $(document).ready(function () {
            $(".test").click(function (event) {
                var val = $(event.target).attr("value");
                var data = val.split(',');
                let start = new Date(data[0]);
                let id = data[1];
                let diff = new Date() - start;
                let minutes = Math.round(((diff % 86400000) % 3600000) / 60000);
                if (minutes > 10 || new Date() < start) $(".testError").each((i, div) => {
                    if (div.getAttribute("value") == id) div.innerText = " This test is unavailable now";
                });
                else location.href = '<%= Url.Action("solveTest", "Tests") %>';
            });

            $(".test").mouseenter(function () {
                $(this).css('font-weight', 'bold');
            });

            $(".test").mouseout(function () {
                $(this).css('font-weight', 'normal');
            });
        });
    </script>
}